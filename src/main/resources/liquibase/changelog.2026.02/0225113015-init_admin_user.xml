<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.27.xsd"
        objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">

    <!-- Insert Admin User -->
    <changeSet id="init-admin-user" author="phongtv">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="users_old"/>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM users_old WHERE email = 'admin@vatek.asia'
            </sqlCheck>
        </preConditions>
        <comment>Create admin user with hashed password (password: admin123)
            Note: BCrypt hash generated with BCryptPasswordEncoder. To generate new hash, use:
            BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
            String hash = encoder.encode("admin123");
        </comment>
        <sql>
            INSERT INTO users_old (
                id,
                created_time,
                created_by,
                username,
                full_name,
                name,
                password_hash,
                email,
                phone,
                citizen_id,
                date_created,
                is_deleted,
                status,
                refresh_token
            ) VALUES (
                UUID(),
                CURRENT_TIMESTAMP,
                'system',
                'admin',
                'Admin User',
                'User',
                '$2y$10$6A82Onep5.6eAIzkwRFYj.1wegjlxsc1iWnBSZb2zcKs61XTIMxrG',
                'admin@vatek.asia',
                '0000000000',
                'ADMIN001',
                CURRENT_TIMESTAMP,
                FALSE,
                'Active',
                NULL
            );
        </sql>
    </changeSet>

    <!-- Assign POSITION_ADMIN to admin user -->
    <changeSet id="assign-admin-position" author="phongtv">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="user_positions"/>
            <tableExists tableName="users_old"/>
            <tableExists tableName="configs"/>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM user_positions
                WHERE user_id = (SELECT id FROM users_old WHERE email = 'admin@vatek.asia' LIMIT 1)
                AND position_id = (SELECT id FROM configs WHERE `key` = 'POSITION' AND `value` = 'POSITION_ADMIN' LIMIT 1)
            </sqlCheck>
        </preConditions>
        <comment>Assign POSITION_ADMIN to admin user</comment>
        <sql>
            INSERT INTO user_positions (user_id, position_id)
            SELECT
                (SELECT id FROM users_old WHERE email = 'admin@vatek.asia' LIMIT 1),
                (SELECT id FROM configs WHERE `key` = 'POSITION' AND `value` = 'POSITION_ADMIN' LIMIT 1);
        </sql>
    </changeSet>

</databaseChangeLog>
